project(runanywhererag)
cmake_minimum_required(VERSION 3.9.0)

set(PACKAGE_NAME runanywhererag)
set(CMAKE_VERBOSE_MAKEFILE ON)
set(CMAKE_CXX_STANDARD 20)

# =============================================================================
# Fetch nlohmann/json for RAG wrapper
# =============================================================================
include(FetchContent)
if(NOT TARGET nlohmann_json::nlohmann_json)
    FetchContent_Declare(
        nlohmann_json
        GIT_REPOSITORY https://github.com/nlohmann/json.git
        GIT_TAG        v3.11.3
        GIT_SHALLOW    TRUE
    )
    FetchContent_MakeAvailable(nlohmann_json)
    # Make nlohmann_json include directory available
    set(NLOHMANN_JSON_INCLUDE "${nlohmann_json_SOURCE_DIR}/include")
else()
    # If target already exists, get its include directory
    get_target_property(NLOHMANN_JSON_INCLUDE nlohmann_json::nlohmann_json INTERFACE_INCLUDE_DIRECTORIES)
endif()

# =============================================================================
# 16KB Page Alignment for Android 15+ (API 35) Compliance
# Required starting November 1, 2025 for Google Play submissions
# =============================================================================
set(CMAKE_SHARED_LINKER_FLAGS "${CMAKE_SHARED_LINKER_FLAGS} -Wl,-z,max-page-size=16384")

# Path to pre-built native libraries (downloaded from runanywhere-binaries)
set(JNILIB_DIR ${CMAKE_SOURCE_DIR}/src/main/jniLibs/${ANDROID_ABI})

# =============================================================================
# RABackendRAG - RAG pipeline backend (REQUIRED)
# Downloaded via Gradle downloadNativeLibs task
# =============================================================================
if(NOT EXISTS "${JNILIB_DIR}/librac_backend_rag.so")
    message(FATAL_ERROR "[RunAnywhereRAG] RABackendRAG not found at ${JNILIB_DIR}/librac_backend_rag.so\n"
                        "Run: ./gradlew :runanywhere_rag:downloadNativeLibs")
endif()

add_library(rac_backend_rag SHARED IMPORTED)
set_target_properties(rac_backend_rag PROPERTIES
    IMPORTED_LOCATION "${JNILIB_DIR}/librac_backend_rag.so"
    IMPORTED_NO_SONAME TRUE
)
message(STATUS "[RunAnywhereRAG] Found RABackendRAG at ${JNILIB_DIR}/librac_backend_rag.so")

# =============================================================================
# RABackendLlamaCPP - Llama LLM backend (REQUIRED for text generation)
# =============================================================================
set(LLAMACPP_JNILIB_DIR "${CMAKE_SOURCE_DIR}/../../llamacpp/android/src/main/jniLibs/${ANDROID_ABI}")
if(NOT EXISTS "${LLAMACPP_JNILIB_DIR}/librac_backend_llamacpp.so")
    message(FATAL_ERROR "[RunAnywhereRAG] RABackendLlamaCPP not found at ${LLAMACPP_JNILIB_DIR}/librac_backend_llamacpp.so\n"
                        "Run: ./gradlew :runanywhere_llamacpp:downloadNativeLibs")
endif()

add_library(rac_backend_llamacpp SHARED IMPORTED)
set_target_properties(rac_backend_llamacpp PROPERTIES
    IMPORTED_LOCATION "${LLAMACPP_JNILIB_DIR}/librac_backend_llamacpp.so"
    IMPORTED_NO_SONAME TRUE
)
message(STATUS "[RunAnywhereRAG] Found RABackendLlamaCPP at ${LLAMACPP_JNILIB_DIR}/librac_backend_llamacpp.so")

# =============================================================================
# RABackendONNX - ONNX backend (REQUIRED for embeddings)
# =============================================================================
set(ONNX_JNILIB_DIR "${CMAKE_SOURCE_DIR}/../../onnx/android/src/main/jniLibs/${ANDROID_ABI}")
if(NOT EXISTS "${ONNX_JNILIB_DIR}/librac_backend_onnx.so")
    message(FATAL_ERROR "[RunAnywhereRAG] RABackendONNX not found at ${ONNX_JNILIB_DIR}/librac_backend_onnx.so\n"
                        "Run: ./gradlew :runanywhere_onnx:downloadNativeLibs")
endif()

add_library(rac_backend_onnx SHARED IMPORTED)
set_target_properties(rac_backend_onnx PROPERTIES
    IMPORTED_LOCATION "${ONNX_JNILIB_DIR}/librac_backend_onnx.so"
    IMPORTED_NO_SONAME TRUE
)
message(STATUS "[RunAnywhereRAG] Found RABackendONNX at ${ONNX_JNILIB_DIR}/librac_backend_onnx.so")

# =============================================================================
# Source files - RAG bridges
# =============================================================================
add_library(${PACKAGE_NAME} SHARED
    src/main/cpp/cpp-adapter.cpp
    ../cpp/HybridRunAnywhereRAG.cpp
)

# =============================================================================
# Fix NitroModules prefab path for library modules
# The prefab config generated by AGP has incorrect paths when building library modules
# We need to create the NitroModules target BEFORE the autolinking.cmake runs
# =============================================================================
if(DEFINED REACT_NATIVE_NITRO_BUILD_DIR)
    # Find NitroModules.so in the app's build directory
    set(NITRO_LIBS_DIR "${REACT_NATIVE_NITRO_BUILD_DIR}/intermediates/merged_native_libs/debug/mergeDebugNativeLibs/out/lib/${ANDROID_ABI}")
    if(EXISTS "${NITRO_LIBS_DIR}/libNitroModules.so")
        message(STATUS "[RunAnywhereRAG] Using NitroModules from app build: ${NITRO_LIBS_DIR}")
        add_library(react-native-nitro-modules::NitroModules SHARED IMPORTED)
        set_target_properties(react-native-nitro-modules::NitroModules PROPERTIES
            IMPORTED_LOCATION "${NITRO_LIBS_DIR}/libNitroModules.so"
        )
    endif()
endif()

# Add Nitrogen specs (this handles all React Native linking)
include(${CMAKE_SOURCE_DIR}/../nitrogen/generated/android/runanywhererag+autolinking.cmake)

# =============================================================================
# Include directories
# =============================================================================
# Get core package include dir (for rac/*.h headers)
get_filename_component(RN_NODE_MODULES "${CMAKE_SOURCE_DIR}/../../.." ABSOLUTE)
set(CORE_INCLUDE_DIR "${RN_NODE_MODULES}/@runanywhere/core/android/src/main/include")
set(CORE_JNILIB_DIR "${RN_NODE_MODULES}/@runanywhere/core/android/src/main/jniLibs/${ANDROID_ABI}")

include_directories(
    "src/main/cpp"
    "../cpp"
    "${CMAKE_SOURCE_DIR}/include"
    # RAC API headers from core package (flat access for all subdirectories)
    "${CORE_INCLUDE_DIR}"
    "${CORE_INCLUDE_DIR}/rac"
    "${CORE_INCLUDE_DIR}/rac/core"
    "${CORE_INCLUDE_DIR}/rac/backends"
    "${CORE_INCLUDE_DIR}/rac/backends/rag"
    "${CORE_INCLUDE_DIR}/rac/backends/llamacpp"
    "${CORE_INCLUDE_DIR}/rac/backends/onnx"
    # nlohmann/json headers from FetchContent
    "${NLOHMANN_JSON_INCLUDE}"
)

# =============================================================================
# RACommons - Core SDK functionality (from core package)
# =============================================================================
if(NOT EXISTS "${CORE_JNILIB_DIR}/librac_commons.so")
    message(FATAL_ERROR "[RunAnywhereRAG] RACommons not found at ${CORE_JNILIB_DIR}/librac_commons.so\n"
                        "Run: ./gradlew :runanywhere_core:downloadNativeLibs")
endif()

add_library(rac_commons SHARED IMPORTED)
set_target_properties(rac_commons PROPERTIES
    IMPORTED_LOCATION "${CORE_JNILIB_DIR}/librac_commons.so"
    IMPORTED_NO_SONAME TRUE
)
message(STATUS "[RunAnywhereRAG] Found RACommons at ${CORE_JNILIB_DIR}/librac_commons.so")

# =============================================================================
# Linking - All backends are REQUIRED
# =============================================================================
find_library(LOG_LIB log)

target_link_libraries(
    ${PACKAGE_NAME}
    ${LOG_LIB}
    android
    rac_commons
    rac_backend_rag
    rac_backend_llamacpp
    rac_backend_onnx
)

# Define availability flags
target_compile_definitions(${PACKAGE_NAME} PRIVATE 
    HAS_RAG=1
    HAS_LLAMACPP=1 
    HAS_ONNX=1
    HAS_RACOMMONS=1
    RAG_HAS_LLAMACPP_PROVIDER=1
    RAG_HAS_ONNX_PROVIDER=1
    ORT_API_VERSION=17
)

# 16KB page alignment - MUST be on target for Android 15+ compliance
target_link_options(${PACKAGE_NAME} PRIVATE -Wl,-z,max-page-size=16384)
