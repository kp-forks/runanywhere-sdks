project(runanywherecore)
cmake_minimum_required(VERSION 3.9.0)

set(PACKAGE_NAME runanywherecore)
set(CMAKE_VERBOSE_MAKEFILE ON)
set(CMAKE_CXX_STANDARD 20)

# =============================================================================
# nlohmann/json - Header-only JSON library for robust JSON parsing
# Used by ToolCallingBridge for parsing tool call JSON from LLM output
# =============================================================================
include(FetchContent)
FetchContent_Declare(
    nlohmann_json
    GIT_REPOSITORY https://github.com/nlohmann/json.git
    GIT_TAG v3.11.3
    GIT_SHALLOW TRUE
)
FetchContent_MakeAvailable(nlohmann_json)

# =============================================================================
# 16KB Page Alignment for Android 15+ (API 35) Compliance
# Required starting November 1, 2025 for Google Play submissions
# =============================================================================
set(CMAKE_SHARED_LINKER_FLAGS "${CMAKE_SHARED_LINKER_FLAGS} -Wl,-z,max-page-size=16384")

# Path to pre-built native libraries (downloaded from runanywhere-sdks)
set(JNILIB_DIR ${CMAKE_SOURCE_DIR}/src/main/jniLibs/${ANDROID_ABI})

# Path to RAC headers (downloaded with native libraries)
set(RAC_INCLUDE_DIR ${CMAKE_SOURCE_DIR}/src/main/include)

# =============================================================================
# RACommons - Core SDK functionality (rac_* API)
# This is the ONLY native library in the core package
# RACommons is REQUIRED - it's downloaded via Gradle downloadNativeLibs task
# =============================================================================
if(NOT EXISTS "${JNILIB_DIR}/librac_commons.so")
    message(WARNING "[RunAnywhereCore] RACommons not found for ${ANDROID_ABI} at ${JNILIB_DIR}/librac_commons.so\n"
                    "This ABI will not be functional. To fix, run: ./gradlew :runanywhere_core:downloadNativeLibs\n"
                    "Or set reactNativeArchitectures=arm64-v8a in gradle.properties to skip this ABI.")
    # Create a minimal stub library so the build can proceed for other ABIs
    file(WRITE "${CMAKE_CURRENT_BINARY_DIR}/stub.cpp" "// Stub for missing ABI ${ANDROID_ABI}")
    add_library(${PACKAGE_NAME} SHARED "${CMAKE_CURRENT_BINARY_DIR}/stub.cpp")
    return()
endif()

add_library(rac_commons SHARED IMPORTED)
set_target_properties(rac_commons PROPERTIES
    IMPORTED_LOCATION "${JNILIB_DIR}/librac_commons.so"
    IMPORTED_NO_SONAME TRUE
)
message(STATUS "[RunAnywhereCore] Found RACommons at ${JNILIB_DIR}/librac_commons.so")

# =============================================================================
# Source files - Core bridges only (no LLM/STT/TTS/VAD)
# =============================================================================
# Collect core bridge source files
file(GLOB BRIDGE_SOURCES "../cpp/bridges/*.cpp")
# TODO: Re-enable ToolCallingBridge when commons library includes rac_tool_call_* functions
# Currently disabled because these functions aren't in commons v0.1.4
list(FILTER BRIDGE_SOURCES EXCLUDE REGEX ".*ToolCallingBridge\\.cpp$")

add_library(${PACKAGE_NAME} SHARED
    src/main/cpp/cpp-adapter.cpp
    ../cpp/HybridRunAnywhereCore.cpp
    ${BRIDGE_SOURCES}
)

# =============================================================================
# Fix NitroModules prefab path for library modules
# The prefab config generated by AGP has incorrect paths when building library modules
# We need to create the NitroModules target BEFORE the autolinking.cmake runs
# =============================================================================
if(DEFINED REACT_NATIVE_NITRO_BUILD_DIR)
    # Find NitroModules.so in the app's build directory
    set(NITRO_LIBS_DIR "${REACT_NATIVE_NITRO_BUILD_DIR}/intermediates/merged_native_libs/debug/mergeDebugNativeLibs/out/lib/${ANDROID_ABI}")
    if(EXISTS "${NITRO_LIBS_DIR}/libNitroModules.so")
        message(STATUS "[RunAnywhereCore] Using NitroModules from app build: ${NITRO_LIBS_DIR}")
        add_library(react-native-nitro-modules::NitroModules SHARED IMPORTED)
        set_target_properties(react-native-nitro-modules::NitroModules PROPERTIES
            IMPORTED_LOCATION "${NITRO_LIBS_DIR}/libNitroModules.so"
        )
    endif()
endif()

# Add Nitrogen specs (this handles all React Native linking)
include(${CMAKE_SOURCE_DIR}/../nitrogen/generated/android/runanywherecore+autolinking.cmake)

# =============================================================================
# Include directories
# =============================================================================
include_directories(
    "src/main/cpp"
    "../cpp"
    "../cpp/bridges"
    "../cpp/third_party"
    "${CMAKE_SOURCE_DIR}/include"
    # RAC API headers from runanywhere-commons (flat access)
    "${RAC_INCLUDE_DIR}"
    "${RAC_INCLUDE_DIR}/rac"
    "${RAC_INCLUDE_DIR}/rac/core"
    "${RAC_INCLUDE_DIR}/rac/core/capabilities"
    "${RAC_INCLUDE_DIR}/rac/features"
    "${RAC_INCLUDE_DIR}/rac/features/llm"
    "${RAC_INCLUDE_DIR}/rac/features/stt"
    "${RAC_INCLUDE_DIR}/rac/features/tts"
    "${RAC_INCLUDE_DIR}/rac/features/vad"
    "${RAC_INCLUDE_DIR}/rac/features/voice_agent"
    "${RAC_INCLUDE_DIR}/rac/features/platform"
    "${RAC_INCLUDE_DIR}/rac/infrastructure"
    "${RAC_INCLUDE_DIR}/rac/infrastructure/device"
    "${RAC_INCLUDE_DIR}/rac/infrastructure/download"
    "${RAC_INCLUDE_DIR}/rac/infrastructure/events"
    "${RAC_INCLUDE_DIR}/rac/infrastructure/model_management"
    "${RAC_INCLUDE_DIR}/rac/infrastructure/network"
    "${RAC_INCLUDE_DIR}/rac/infrastructure/storage"
    "${RAC_INCLUDE_DIR}/rac/infrastructure/telemetry"
)

# =============================================================================
# Linking
# =============================================================================
find_library(LOG_LIB log)

target_link_libraries(
    ${PACKAGE_NAME}
    ${LOG_LIB}
    android
)

# Link RACommons - REQUIRED for core functionality
target_link_libraries(${PACKAGE_NAME} rac_commons)
target_compile_definitions(${PACKAGE_NAME} PRIVATE HAS_RACOMMONS=1)

# Link nlohmann_json for ToolCallingBridge
target_link_libraries(${PACKAGE_NAME} nlohmann_json::nlohmann_json)

# 16KB page alignment - MUST be on target for Android 15+ compliance
target_link_options(${PACKAGE_NAME} PRIVATE -Wl,-z,max-page-size=16384)

# NOTE: No LlamaCPP or ONNX linking here
# Those are in @runanywhere/llamacpp and @runanywhere/onnx packages respectively
